(function() {  

  var app = angular.module('earfulOfAngular',['ngMap']);

  app.controller('FeedController', ['$scope','$http', function($scope, $http) {
    $scope.editItem = false;
    starting_point = (document.URL).indexOf('/users/') + 7;
    ending_point = (document.URL).search('/posts');
    $scope.userId = (document.URL).substring(starting_point,ending_point);

    $scope.map = {};
    $scope.markers = [];


    // variables for MySounds page
    $scope.mySounds = [];
    // Get request to retreive mySounds
    $http.get('/users/'+ $scope.userId +'/posts.json').success(function(data){
      $scope.mySounds = data.posts
      console.log($scope.mySounds);
      $('#mySounds').addClass('selected')
    });

    $scope.loadMyFeed = function(){
      $('#myfeed').removeClass('hide');
      $('#feedList').addClass('hide');
      $('#mapOfSounds').addClass('hide');
      $('#feed').removeClass('selected')
      $('#mySounds').addClass('selected')


    }

    $scope.selectEditItem = function(item){
      $scope.editItem = item;
    }

    $scope.selectUpdateItem = function(item){
      $http.put('/users/'+ $scope.userId + '/posts/' + item.id + '.json', item ).success(function(data){
        $scope.editItem = 0;
        var index = $scope.mySounds.indexOf(item);
        console.log(data.post);
        $scope.mySounds.splice(index, 1, data.post);
      });
    }

    $scope.togglePost = function(event){
      // locate the class postConent within the post item and toggle it shown or hidden
      $(event.target).parent('.post').find('.postContent').slideToggle(500, function(){});
    }

    // functions for the Feed page
    $scope.loadFeed = function(){
      $('#myfeed').addClass('hide');
      $('#mapOfSounds').addClass('hide');
      $('#feedList').removeClass('hide');
      $('#userSearch').addClass('hide')
      $('#feed').addClass('selected')
      $('#mySounds').removeClass('selected')

      // variables for Feed page
      $scope.followedPosts = [];
      //Get request to retreive publicPosts
      $http.get('/users/'+ $scope.userId +'/followed.json').success(function(data){
        $scope.followedPosts = data.feeds;
      });
    }

    $scope.searchUsers  = function(){

      $('#myfeed').addClass('hide');
      $('#mapOfSounds').addClass('hide');
      $('#feedList').addClass('hide');
      $('#userSearch').removeClass('hide')

      $scope.users = [];

      $http.get('/fetch_users.json').success(function(data){
        $scope.users = data.feeds;
        console.log($scope.users)
      });
    }

    $scope.followUser = function(user){
     console.log(user.id);
      $http.post('/relationships.json', { relationship:{
        follower_id: $scope.userId,
        followed_id: user.id
      }}).success(function(data){
        console.log("successfully created a new relationship");
      });
    }

    $scope.unfollowUser = function(item){
      $http.get('/users/'+item.user_id+'/unfollow.json').success(function(data){
        console.log('post to unfollow user successful')
        index = $scope.followedPosts.indexOf(item);
        //remove that relationships items from feed
        $scope.followedPosts.splice(index, 1);
      });
    }
    
    $scope.loadMap = function(){ 
      $('#myfeed').addClass('hide');
      $('#mapLink').addClass('selected');
      $('#mapOfSounds').removeClass('hide');
      $('#userSearch').addClass('hide')

      $scope.audioIcon = "/audioIcon.png"

      $scope.mapStyle = [{"featureType":"road","elementType":"labels","stylers":[{"visibility":"simplified"},{"lightness":20}]},{"featureType":"administrative.land_parcel","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"landscape.man_made","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road.local","elementType":"labels","stylers":[{"visibility":"simplified"}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"labels","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.arterial","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"hue":"#a1cdfc"},{"saturation":30},{"lightness":49}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"hue":"#f49935"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"hue":"#fad959"}]}]

      var geocoder = new google.maps.Geocoder();
      $.each( $scope.mySounds, function( index, value ){
           geocoder.geocode({
              'address': value.location
           }, 
           function(results, status) {
              if(status == google.maps.GeocoderStatus.OK) {
                 new google.maps.Marker({
                    position: results[0].geometry.location,
                    icon: $scope.audioIcon,
                    title: value.location,
                    map: $scope.map
                 });
                 $scope.map.setCenter(results[0].geometry.location);
                 $scope.map.setOptions({styles: $scope.mapStyle});
              }
           });
          
      });

      $scope.$on('mapInitialized', function(event, map) {
        $scope.map.setCenter({
          center: {
            latitude: 45,
            longitude: -73
          },
          zoom: 8

        });
      });
      
    }


  }]);

})();